---
title: "Working in iglu"
author: "Steve Broll, Irina Gaynanova"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working in iglu}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(iglu)
# date: "`r Sys.Date()`"
```

The iglu package is developed to assist the analyses of data from Continuous Glucose Monitors (CGMs). CGMs are small wearable devices that measure the glucose levels continuously throughout the day, with some monitors taking measurements as often as every 5 minutes. Data from these monitors provide a detailed quantification of the variation in blood glucose levels during the course of the day, and thus CGMs play an increasing role in clinical practice. For more on CGMs, see [Rodbard (2006) "Continuous Glucose Monitoring: A Review of Successes, Challenges, and Opportunities."](https://doi.org/10.1089/dia.2015.0417).

Multiple CGM-derived metrics have been developed to assess the quality of glycemic control and glycemic variability, many of which are summarized in [Rodbard (2009) "Interpretation of continuous glucose monitoring data: glycemic variability and quality of glycemic control."](https://www.ncbi.nlm.nih.gov/pubmed/19469679). The iglu package streamlines the calculation of these metrics by providing clearly named functions that output metrics values with one line of code. 

The iglu package is designed with the following three components of Continuous Glucose Monitor (CGM) data in mind:

* Blood glucose level measurement [in mg/dL]

* Timestamp for glucose measurement

* Subject identification

The iglu package comes with the example data from 5 subjects with Type II diabetes whose glucose leveles were measured using Dexcom G4 CGM.  

# Calculating time-independent metrics

## Example data for 1 subject

Example data with 1 subject can be loaded with:

```{r}
data("example_data_1_subject")
```
  
This dataset contains 2915 observations of 3 columns corresponding to the three components listed in the introduction:

* `"id"` - Factor (character string) column for subject identification
* `"time"` - Factor (character string) column that can be converted to DateTime for measurement timestamp
* `"gl"` - Numeric column for glucose measurement

Data used with iglu functions may have additional columns, but the columns for id, time and glucose values must be named as above.

```{r}
dim(example_data_1_subject)
str(example_data_1_subject)
head(example_data_1_subject)
```

## Example data for 5 subjects

Example data with multiple subjects can be loaded with:

```{r}
data("example_data_5_subject")
```
  
This dataset contains the same 3 columns as the dataset in the single subject case, but now with 13866 observations from 5 subjects. The first subject in this multiple subject dataset is the same as the single subject from the previous examples.

```{r}
dim(example_data_5_subject)
str(example_data_5_subject)
```

## Example metrics

All metric functions in iglu will produce the output in a tibble form. See documentation on tibbles with vignette('tibble') or ?`tbl_df-class` .

Some metric functions, like `above_percent()`, will return multiple values for a single subject. 

```{r}
above_percent(example_data_1_subject)
```

Subject id will always be printed in the id column, and metrics will be printed in the following columns. The list of target values for the above_percent metric is a parameter that can be changed:

```{r}
above_percent(example_data_1_subject, targets = c(100, 200, 300))
```

Many metrics have parameters that can be changed. To see available parameters for a given metric, see the documentation i.e. ?above_percent or help(above_percent).  

Some metric functions, like `quantile_glu()`, will return multiple values for each subject, producing a dataframe with >2 columns and >1 rows. 

```{r}
quantile_glu(example_data_5_subject)
```

Other metric functions, like `MAGE()` (Mean Amplitude of Glycemic Excursions), will return just a single value for each subject, producing a 2 column dataframe with a row for each subject.

```{r}
mage(example_data_5_subject)
```

Note: `base::as.numeric()` will produce an error when wrapped around a data.frame with more >1 row.


# Calculating time-dependent metrics

Observe that the timestamps in the first rows are not evenly spaced. Linear interpolation is used where appropriate for computation of metrics that require a time component with equally spaced measurements. Time intervals within large gaps between variables will not be interpolated, but instead will be treated as missing values. 

[Add a little more on interpolation (potentially explicit example with CGMs2DayBy Day) and then a note on time zone]

Some metric functions, like `conga()` (Continuous Overlapping Net Glycemic Action), will return just a single value for each subject,
resulting in a 2 column tibble (1 column for id and 1 for the single value).

```{r, cache = T}
conga(example_data_1_subject)
```

Note: `base::as.numeric()` can be used to convert output to a numeric value or vector instead of a tibble object *only* when working with a single subject.

```{r, cache = T}
as.numeric(conga(example_data_1_subject))
as.numeric(above_percent(example_data_1_subject))
```


# Visualizations

The iglu package currently supports 3 plot types:

* Time series plot
* Unsorted lasagna plot
* Row sorted lasagna plot

The time series plot is the default type for the function `plot_glu`. This plot type can support both single and multiple subjects.

```{r}
plot_glu(example_data_1_subject, plottype = 'tsplot', tz = "EST")
plot_glu(example_data_5_subject, plottype = 'tsplot', tz = "EST")
```

We set the 'tz' (timezone) parameter to be EST because the data was collected in the eastern time zone. If left blank, the time zone used for plotting will be the system's time zone. Time zone is mainly an issue in cases where daylight savings time might make it appear as though there were duplicate values at some time points.

To just plot a single subject of interest from the grid of time series plots, set the 'subjects' parameter to be that subject's ID.

```{r}
plot_glu(example_data_5_subject, plottype = 'tsplot', subjects = 'Subject 3', tz = "EST")
```

The red lines can be shifted to any Lower and Upper Target Range Limits with the 'LLTR' and 'ULTR' arguments.

```{r}
plot_glu(example_data_5_subject, plottype = 'tsplot', subjects = 'Subject 3', LLTR = 80, ULTR = 150, tz = "EST")
```

The `plot_glu` function also supports lasagna plots by changing the 'plottype' parameter. For more on lasagna plots, see [Swihart et al. (2010) "Lasagna Plots: A Saucy Alternative to Spaghetti Plots." ](https://doi.org/10.1097/ede.0b013e3181e5b06a)

```{r, cache = T}
plot_glu(example_data_5_subject, plottype = 'lasagna', tz = 'EST')
```

By default, this will produce an unsorted lasagna plot using up to 14 days worth of data displayed separately. To average across days at each time point, we can use `datatype = 'average'`:

```{r, cache = T}
plot_glu(example_data_5_subject, plottype = 'lasagna', datatype = 'average', tz = 'EST')
```

We can additionally sort the values at each time point across the five subjects by setting `lasagnatype = 'timesorted'

```{r, cache = T}
plot_glu(example_data_5_subject, plottype = 'lasagna', datatype = 'average', lasagnatype = 'timesorted', tz = 'EST')
```

When working with a single subject, setting `datatype = single` will produce plots where rows represent days instead of subjects.

```{r, cache = T}
plot_glu(example_data_1_subject, plottype = 'lasagna', datatype = 'single', lasagnatype = 'unsorted', tz = 'EST')
```

```{r, cache = T}
plot_glu(example_data_1_subject, plottype = 'lasagna', datatype = 'single', lasagnatype = 'timesorted', tz = 'EST')

```

For further customization of lasagna plots, use the `plot_lasagna` and `plot_lasagna_1subject` functions. 

`plot_lasagna` allows for multi-subject lasagna plots with the additional options of sorting the hours by glucose values for each subject, i.e. horizontal sorting, by setting
`lasagnatype = 'subjectsorted'`.

```{r, cache = T}
plot_lasagna(example_data_5_subject, datatype = 'average', lasagnatype = 'subjectsorted', tz = 'EST')
```

`plot_lasagna` also supports changing the maximum number of days to display, as well as the upper and lower target range limits (LLTR and ULTR), midpoint, and minimum and maximum values to display, all of which will affect the colorbar.

```{r, cache = T}
plot_lasagna(example_data_5_subject, datatype = 'average', lasagnatype = 'subjectsorted', LLTR = 100, ULTR = 180, midpoint = 150, limits = c(80, 500), tz = 'EST')
```

`plot_lasagna_1subject` allows for customization of the more detailed single subject lasagna plots. There is no datatype parameter for `plot_lasagna_1subject`, but there are three types of plots available, accessed with the `lasagnatype` parameter.

```{r, cache = T}
plot_lasagna_1subject(example_data_1_subject, lasagnatype = 'unsorted', tz = 'EST')
```

```{r, cache = T}
plot_lasagna_1subject(example_data_1_subject, lasagnatype = 'timesorted', tz = 'EST')
```

```{r, cache = T}
plot_lasagna_1subject(example_data_1_subject, lasagnatype = 'daysorted', tz = 'EST')
```

As with the `lasagna_plot` function, changing the LLTR, ULTR, midpoint, and limits parameters will affect the colorbar.

```{r, cache = T}
plot_lasagna_1subject(example_data_1_subject, lasagnatype = 'daysorted', midpoint = 150, limits = c(80,500), tz = 'EST')
```

# Shiny App

The iglu package comes with a shiny app containing all of the metric calculations as well as all plot types of the package itself.
  
The full app can be accessed by running `iglu::run_shiny()` (iglu must be installed to use the `run_shiny` function).
  
The app itself has a demo available at [https://stevebroll.shinyapps.io/shinyigludemo/](https://stevebroll.shinyapps.io/shinyigludemo/) with data pre-loaded.
