---
title: "Working in iglu"
author: "Steve Broll, Irina Gaynanova"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working in iglu}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(iglu)
# date: "`r Sys.Date()`"
```

The iglu package is designed with the following three components of Continuous Glucose Monitor (CGM) data in mind:

* Blood glucose level

* Timestamp for measurement

* Subject identification

There are many metrics used to assess glycemic variability, many of which can be found in ["Interpretation of continuous glucose monitoring data: glycemic variability and quality of glycemic control." Rodbard (2009)](https://www.ncbi.nlm.nih.gov/pubmed/19469679). The iglu package streamlines the calculation of metrics by providing clearly named functions that output metrics with one line of code. 

# Single Subject Workflow
## Data

Example data with 1 subject can be loaded with:

```{r}
data("example_data_1_subject")
```
  
This dataset contains 2915 observations of 3 columns corresponding to the three components listed in the introduction:

* `"id"` - Factor (character string) column for subject identification
* `"time"` - Factor (character string) column that can be converted to DateTime for measurement timestamp
* `"gl"` - Numeric column for glucose measurement

Data used with iglu functions may have additional columns, but the columns for id, time and glucose values must be named as above.

```{r}
dim(example_data_1_subject)
str(example_data_1_subject)
head(example_data_1_subject)
```

Observe that the timestamps in the first rows are not evenly spaced. Linear interpolation is used where appropriate for computation of metrics that require a time component with equally spaced measurements. Time intervals within large gaps between variables will not be interpolated, but instead will be treated as missing values. 

## Calculating Metrics

All metric functions in iglu will produce the output in a tibble form. See documentation on tibbles with vignette('tibble') or ?`tbl_df-class` .

Some metric functions, like `above_percent()`, will return multiple values for a single subject. 

```{r}
above_percent(example_data_1_subject)
```

Subject id will always be printed in the id column, and metrics will be printed in the following columns. The list of target values for the above_percent metric is a parameter that can be changed:

```{r}
above_percent(example_data_1_subject, targets = c(100, 200, 300))
```

Many metrics have parameters that can be changed. To see available parameters for a given metric, see the documentation i.e. ?above_percent or help(above_percent).  
Some metric functions, like `conga()` (Continuous Overlapping Net Glycemic Action), will return just a single value for each subject,
resulting in a 2 column tibble (1 column for id and 1 for the single value).

```{r}
conga(example_data_1_subject)
```

Note: `base::as.numeric()` can be used to convert output to a numeric value or vector instead of a tibble object *only* when working with a single subject.

```{r}
as.numeric(conga(example_data_1_subject))

as.numeric(above_percent(example_data_1_subject))
```

# Multiple Subject Workflow

## Data

Example data with multiple subjects can be loaded with:

```{r}
data("example_data_5_subject")
```
  
This dataset contains the same 3 columns as the dataset in the single subject case, but now with 13866 observations from 5 subjects. The first subject in this multiple subject dataset is the same as the single subject from the previous examples.

```{r}
dim(example_data_5_subject)
str(example_data_5_subject)
```

## Calculating Metrics

Some metric functions, like `quantile_glu()`, will return multiple values for each subject, producing a dataframe with >2 columns and >1 rows. 

```{r}
quantile_glu(example_data_5_subject)
```

Other metric functions, like `MAGE()` (Mean Amplitude of Glycemic Excursions), will return just a single value for each subject, producing a 2 column dataframe with a row for each subject.

```{r}
mage(example_data_5_subject)
```

Note: `base::as.numeric()` will produce an error when wrapped around a data.frame with more >1 row.

# Visualizations

The iglu package currently supports 3 plot types:

* Time series plot
* Unsorted lasagna plot
* Row sorted lasagna plot

The time series plot tpye is the default type. This plot type can support both single and multiple subjects.

```{r}
plot_glu(example_data_1_subject, plottype = 'tsplot', tz = "EST")
plot_glu(example_data_5_subject, plottype = 'tsplot', tz = "EST")
```

We set the 'tz' (timezone) parameter to be EST because the data was collected in the eastern time zone. If left blank, the time zone used for plotting will be the system's time zone. Time zone is mainly an issue in cases where daylight savings time might make it appear as though there were duplicate values at some time points.

To just plot a single subject of interest from the grid of time series plots, set the 'subjects' parameter to be that subject's ID.

```{r}
plot_glu(example_data_5_subject, plottype = 'tsplot', subjects = 'Subject 3', tz = "EST")
```

The red lines can be shifted to any Lower and Upper target range limits with the 'LLTR' and 'ULTR' arguments.

```{r}
plot_glu(example_data_5_subject, plottype = 'tsplot', subjects = 'Subject 3', LLTR = 80, ULTR = 150, tz = "EST")
```


Need to add more

The unsorted and row sorted lasagna plots are identical in their usage, other than changing the `lasagnatype` parameter.

```{r}
plot_glu(example_data_1_subject, plottype = 'lasagna', datatype = "single", lasagnatype = "unsorted")
plot_glu(example_data_1_subject, plottype = 'lasagna', datatype = "single", lasagnatype = "timesorted")
```

Need to add more

# Shiny App

The iglu package comes with a shiny app containing all of the metric calculations as well as all plot types of the package itself.
  
The full app can be accessed at [https://stevebroll.shinyapps.io/shinyiglu/](https://stevebroll.shinyapps.io/shinyiglu/), or by running `iglu::run_shiny()` (iglu must be installed to use the run_shiny function).
  
The app itself has a demo available at [https://stevebroll.shinyapps.io/shinyiglu/](https://stevebroll.shinyapps.io/shinyigludemo/) with data pre-loaded.
